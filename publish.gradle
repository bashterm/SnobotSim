import org.gradle.internal.os.OperatingSystem

apply plugin: 'maven-publish'


task combineLibrariesIntoOne(type: Jar) {

    def os_name = org.gradle.internal.os.OperatingSystem.current().getFamilyName();

    classifier = "uber_native-" + os_name;
    
    if(new File('ctre_override/build/libs/ctre_override.jar').exists()) 
    {
        from(zipTree('ctre_override/build/libs/ctre_override.jar')) 
        from(zipTree('ctre_override/build/ctre_override-native-' + os_name + ".jar"))
    }
    from(zipTree('hal_override/build/halAthena-native-' + os_name + ".jar"))
    from(zipTree('snobot_sim/build/snobotSim-native-' + os_name + ".jar"))
    from(zipTree('snobot_sim_gui/build/snobot_sim_gui-native-' + os_name + ".jar"))
    
    def wpiutil_path = "build/dependencies/wpiutil-cpp/" + os_name + "x86-64/" + os_name + "/x86-64/shared"

    from(wpiutil_path) {
        into os_name + "/x86-64/"
        include "*.dll"
        include "*.so"
    }
}


task gatherWpiLibs(type: Zip) {
    def os_name = org.gradle.internal.os.OperatingSystem.current().getFamilyName();

    classifier = "wpi_native-" + os_name;
    
    from('build/dependencies/wpiutil-cpp/' + os_name + 'x86-64/' + os_name + '/x86-64/shared') {
        into "lib"
        
        include "*.dll"
        include "*.lib"
        include "*.so"
    }
    from('build/dependencies/ntcore-cpp/' + os_name + 'x86-64/' + os_name + '/x86-64/shared') {
        into "lib"
    
        include "*.dll"
        include "*.lib"
        include "*.so"
    }
    from('build/dependencies/wpilibc/lib/' + os_name + '/x86-64/shared') {
        into "lib"
    
        include "*.dll"
        include "*.lib"
        include "*.so"
    }
}
    
task gatherWpiHeaders(type: Zip) {

    classifier = "wpi_headers";
    
    from('build/dependencies/wpiutil-cpp/headers') {
        into "include"
    }
    from('build/dependencies/ntcore-cpp/headers') {
        into "include"
    }
    from('build/dependencies/hal') {
        into "include"
    }
    from('build/dependencies/wpilibc/include') {
        into "include"
    }
    from('ctre_override/cpp/include') {
        into "include"
    }
}


publishing {

    repositories {
       maven {
           url maven_publishing_path
       }
    }
    

    publications {
        uberNative(MavenPublication) {
            artifact combineLibrariesIntoOne
        
            groupId 'com.snobot.simulator'
            artifactId 'snobot_sim_native'
            version maven_version
        }
    }

    publications {
        wpilibCopies(MavenPublication) {
            artifact gatherWpiLibs
            artifact gatherWpiHeaders
        
            groupId 'com.snobot.simulator'
            artifactId 'wpilib'
            version maven_version
        }
    }
}
