import org.gradle.internal.os.OperatingSystem
import de.undercouch.gradle.tasks.download.Download

buildscript {
    repositories {
        maven {
            url "https://plugins.gradle.org/m2/"
        }
    }
    dependencies {
        classpath 'net.ltgt.gradle:gradle-errorprone-plugin:0.0.8'
        classpath 'gradle.plugin.edu.wpi.first.wpilib.versioning:wpilib-version-plugin:1.4'
    }
}
plugins {
    id "de.undercouch.download" version "3.2.0"
}

ext.buildArm = !project.hasProperty('skipArm')

task download_wpilibs (type: Copy) {

	def output_folder = new File("${rootDir}/external_dependencies/")

    if( !output_folder.exists() ) {
      output_folder.mkdirs()
    }
    
    
    if(project.hasProperty('local_wpilib'))
    {
	    from project.local_wpilib
	    into output_folder
    }
    else
    {
        //apply plugin: download
	    task downloadFile(type: Download) {

		    src "http://ci.appveyor.com/api/projects/pjreiniger/tempallwpi/artifacts/AthenaHal.zip"
		    dest output_folder
		    onlyIfNewer true
		    
	        from zipTree(output_folder.toString() + "/AthenaHal.zip")
	        into output_folder
		}
		
		dependsOn downloadFile
    }
}

if (hasProperty('makeDesktop')) {
    println 'Making desktop classifier jar. NOTE: This desktop version should only be used for local testing.' +
            'It will only support the current platform, and will override fetching the latest development version from' +
            ' the maven repo until you manually delete it!'
}

ext.getPlatformPath = { binary ->
    if (binary.targetPlatform.architecture.arm) {
        return 'Linux/arm'
    } else if (binary.targetPlatform.operatingSystem.linux) {
        if (binary.targetPlatform.architecture.amd64) {
            return 'Linux/amd64'
        } else {
            return 'Linux/' + binary.targetPlatform.architecture.name
        }
    } else if (binary.targetPlatform.operatingSystem.windows) {
        if (binary.targetPlatform.architecture.amd64) {
            return 'Windows/amd64'
        } else {
            return 'Windows/' + binary.targetPlatform.architecture.name
        }
    } else if (binary.targetPlatform.operatingSystem.macOsX) {
        if (binary.targetPlatform.architecture.amd64) {
            return 'Mac OS X/x86_64'
        } else {
            return 'Mac OS X/' + binary.targetPlatform.architecture.name
        }
    } else {
        return binary.targetPlatform.operatingSystem.name + '/' + binary.targetPlatform.architecture.name
    }
}

ext.setupDefines = { project, binaries ->
    binaries.all {
	if (project.hasProperty('debug')) {
	    project.setupDebugDefines(cppCompiler, linker)
	} else {
	    project.setupReleaseDefines(cppCompiler, linker)
	}
    }
}

apply from: "snobot_sim/snobot_sim.gradle"
apply from: "wpiutil.gradle"
apply from: "hal_override/hal_override.gradle"
apply from: "ctre_override/ctre_override.gradle"

// Empty task for build so that ntcoreSourceZip and wpiutilSourceZip will be
// built when running ./gradlew build
task build

build.dependsOn download_wpilibs
build.dependsOn snobotSimHalSourceZip
build.dependsOn wpiutilSourceZip

apply from: 'publish.gradle'

apply from: 'create_sim_package.gradle'

task install(type: Copy) {

	dependsOn copyNativeSharedLibs
	dependsOn copyNativeStaticLibs
	dependsOn copyJar
}

task wrapper(type: Wrapper) {
    gradleVersion = '3.3'
}

