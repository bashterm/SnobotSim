
import org.gradle.internal.os.OperatingSystem

ext.wpilibBuildPath = "${rootDir}/external_dependencies/"
ext.wpilibc_path    = wpilibBuildPath + "/include"
ext.network_tables  = wpilibBuildPath + "/include"

def defineLibraryPaths(targetPlatform)
{
    String architecture = targetPlatform.architecture

    if (OperatingSystem.current().isLinux()) {
 		     
        if (architecture.contains('64')) {  
	        ext.wpilibcLibraryPath       = wpilibBuildPath    + 'libraries/amd64/libwpilibc.so'
	        ext.networkTablesLibraryPath = wpilibBuildPath    + 'libraries/amd64/libntcore.so'
	        ext.wpilibLibraryPath        = wpilibBuildPath    + 'libraries/amd64/libwpiutil.so'
        } else {
	        ext.wpilibcLibraryPath       = wpilibBuildPath    + 'libraries/x86/libwpilibc.so'
	        ext.networkTablesLibraryPath = wpilibBuildPath    + 'libraries/i386/libntcore.so'
	        ext.wpilibLibraryPath        = wpilibBuildPath    + 'libraries/x86/libwpiutil.so'
        }
        
    } else if (OperatingSystem.current().isWindows()) {
        if (architecture.contains('64')) {  
            ext.wpilibcLibraryPath       = wpilibBuildPath    + '/libraries/amd64/wpilibc.lib'
            ext.networkTablesLibraryPath = wpilibBuildPath    + '/libraries/amd64/ntcore.lib'
            ext.wpilibLibraryPath        = wpilibBuildPath    + '/libraries/amd64/wpiutil.lib'
        } else {
            ext.wpilibcLibraryPath       = wpilibBuildPath    + '/libraries/x86/wpilibc.lib'
            ext.networkTablesLibraryPath = wpilibBuildPath    + '/libraries/x86/ntcore.lib'
            ext.wpilibLibraryPath        = wpilibBuildPath    + '/libraries/x86/wpiutil.lib'
        }
    } else {
        throw new GradleException("${name} does not support building on ${ext.buildPlatform}.")
    }


}

    

def ctreOverrideSetupModel = { project ->
    project.model {
        components {
            CTRLibDriver(NativeLibrarySpec) {

               // targetPlatform 'x86'
                targetPlatform 'x64'
                setupDefines(project, binaries)

                project.setupJniIncludes(binaries)
                project.checkNativeSymbols(project.getNativeJNISymbols, "CTRLibDriver")

                binaries.all 
                {
                    tasks.withType(CppCompile) 
                    {
                        defineLibraryPaths(targetPlatform)
                        linker.args  wpilibcLibraryPath
                        linker.args  networkTablesLibraryPath
                        linker.args  wpilibLibraryPath
                    }
                }
                sources {
                    cpp {
                        source {
                            srcDirs = ["${rootDir}/ctre_override/java/jni", "${rootDir}/ctre_override/sim/lib"]
                            includes = ['**/*.cpp']
                        }
                        exportedHeaders {
                            srcDirs = ["${rootDir}/ctre_override/cpp/include", "${rootDir}/ctre_override/sim/include"]
                            
                            project.jniHeadersCtreOverride.outputs.files.each { file ->
                                srcDirs file.getPath()
                            }
                            
                            srcDirs.each {
                        	    def dir = new File("${it}")
                        	    if(!dir.exists())
                        	    {
                        	        println "Missing include directory : " + dir
                        	    	//throw new GradleException("Could not find include directory ${it}")
                        	    }
                            }
                            
                            
                            includes = ['**/*.h']
                        }

                        lib project: ':native:snobotSimHal', library: 'snobotSimHal', linkage: 'shared'
                    }
                }
            }
            
            CtrCpp(NativeLibrarySpec) {

                //targetPlatform 'x86'
                targetPlatform 'x64'
                setupDefines(project, binaries)

                binaries.all 
                {
                    tasks.withType(CppCompile) 
                    {
                        defineLibraryPaths(targetPlatform)
                        linker.args  wpilibcLibraryPath
                        linker.args  networkTablesLibraryPath
                        linker.args  wpilibLibraryPath
                    }
                }
                sources {
                    cpp {
                        source {
                            srcDirs = ["${rootDir}/ctre_override/cpp/lib/", "${rootDir}/ctre_override/sim/lib"]
                            includes = ['**/*.cpp']
                        }
                        exportedHeaders {
                            srcDirs = ["${rootDir}/ctre_override/cpp/include", "${rootDir}/ctre_override/sim/include"]
                            srcDirs ext.wpilibc_path
                            srcDirs ext.network_tables
                            
                            srcDirs.each {
                        	    def dir = new File("${it}")
                        	    if(!dir.exists())
                        	    {
                        	        println "Missing include directory : " + dir
                        	    	//throw new GradleException("Could not find include directory ${it}")
                        	    }
                            }
                            
                            
                            includes = ['**/*.h']
                        }

                        lib project: ':native:snobotSimHal', library: 'snobotSimHal', linkage: 'shared'
                        lib project: ':native:HALAthena', library: 'HALAthena', linkage: 'shared'
                        //lib project: ':native:wpiutil', library: 'wpiutil', linkage: 'static'
                    }
                }
            }
        }
    }
}

project(':native:ctre_override') {
    apply plugin: 'cpp'

    apply from: "${rootDir}/toolchains/native.gradle"
    apply from: "${rootDir}/ctre_override/java/ctre_java.gradle"
    
    ctreOverrideSetupModel(project)
}